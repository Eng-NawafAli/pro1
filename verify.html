<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>التحقق من الحجز | نادي الحريضة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Noto Sans Arabic', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-6">
    <div id="checker-card" class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
        <div id="loading" class="animate-pulse space-y-4">
            <div class="h-20 w-20 bg-gray-200 rounded-full mx-auto"></div>
            <div class="h-4 bg-gray-200 rounded w-3/4 mx-auto"></div>
            <p>جاري التحقق من الحجز...</p>
        </div>

        <div id="result" class="hidden space-y-6">
            <div id="status-icon" class="text-6xl mb-4"></div>
            <h2 id="status-text" class="text-2xl font-black"></h2>
            <div id="booking-details" class="bg-gray-50 p-6 rounded-2xl text-right space-y-2">
                <p><span class="text-gray-400">العميل:</span> <span id="res-name" class="font-bold"></span></p>
                <p><span class="text-gray-400">التاريخ:</span> <span id="res-date" class="font-bold"></span></p>
                <p><span class="text-gray-400">الوقت:</span> <span id="res-time" class="font-bold"></span></p>
                <p><span class="text-gray-400">الباقة:</span> <span id="res-package" class="font-bold"></span></p>
            </div>
            <button id="complete-btn" onclick="completeBooking()"
                class="hidden w-full bg-green-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-green-200">تبديل
                الحالة إلى "تم الحضور"</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ycknumkbdltbdkhmeyqp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlja251bWtiZGx0YmRraG1leXFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMTk3MTAsImV4cCI6MjA4NjY5NTcxMH0.BNCTfaqsul1LkDbG0PyOd63rYZCThUjGxAhgNMnda6w';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get('qr');

        async function verify() {
            if (!bookingId) {
                showError('كود غير صالح');
                return;
            }

            const { data, error } = await supabaseClient
                .from('bookings')
                .select('*')
                .eq('qr_code_id', bookingId)
                .single();

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('result').classList.remove('hidden');

            if (data) {
                document.getElementById('res-name').innerText = data.customer_name;
                document.getElementById('res-date').innerText = data.booking_date;
                document.getElementById('res-time').innerText = data.booking_time;
                document.getElementById('res-package').innerText = data.package;

                if (data.status === 'completed') {
                    showError('هذا الكود مستخدم مسبقاً!', 'warning');
                } else if (data.status === 'paid') {
                    showSuccess('حجز صالح ومدفوع');
                    document.getElementById('complete-btn').classList.remove('hidden');
                } else {
                    showError('الحجز لم يتم دفعه بعد', 'error');
                }
            } else {
                showError('لم يتم العثور على الحجز');
            }
        }

        function showSuccess(msg) {
            document.getElementById('status-icon').innerText = '✅';
            document.getElementById('status-text').innerText = msg;
            document.getElementById('status-text').className = 'text-2xl font-black text-green-500';
        }

        function showError(msg, type = 'error') {
            document.getElementById('status-icon').innerText = type === 'warning' ? '⚠️' : '❌';
            document.getElementById('status-text').innerText = msg;
            document.getElementById('status-text').className = `text-2xl font-black ${type === 'warning' ? 'text-amber-500' : 'text-red-500'}`;
        }

        async function completeBooking() {
            const { error } = await supabaseClient
                .from('bookings')
                .update({ status: 'completed' })
                .eq('qr_code_id', bookingId);

            if (!error) {
                alert('تم تسجيل الدخول بنجاح!');
                window.location.reload();
            }
        }

        verify();
    </script>
</body>

</html>