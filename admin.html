<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ŸÖÿ±ŸÉÿ≤ ÿßŸÑŸÇŸäÿßÿØÿ© | ŸÜÿßÿØŸä ÿßŸÑÿ≠ÿ±Ÿäÿ∂ÿ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&family=Noto+Sans+Arabic:wght@400;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --accent: #f43f5e;
            --bg-dark: #020617;
        }

        body {
            font-family: 'Noto Sans Arabic', 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            color: #f8fafc;
            overflow-x: hidden;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-dark {
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .animate-gradient {
            background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #020617 100%);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 11px;
            text-transform: uppercase;
        }

        .paid {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .pending {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .completed {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .toast-enter {
            transform: translateY(-20px);
            opacity: 0;
        }

        .toast-visible {
            transform: translateY(0);
            opacity: 1;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            border-color: rgba(99, 102, 241, 0.3);
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body class="animate-gradient min-h-screen">
    <div id="toast-container"
        class="fixed top-8 left-1/2 -translate-x-1/2 z-[100] flex flex-col items-center gap-4 pointer-events-none w-full max-w-sm">
    </div>

    <audio id="notification-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>

    <!-- Login Section -->
    <div id="login-container" class="flex items-center justify-center min-h-screen p-6">
        <div
            class="glass p-12 rounded-[3rem] w-full max-w-md shadow-[0_0_50px_rgba(99,102,241,0.1)] relative overflow-hidden">
            <div class="absolute -top-12 -right-12 w-64 h-64 bg-primary/10 rounded-full blur-[80px]"></div>

            <div class="relative z-10 text-center space-y-10">
                <div
                    class="w-24 h-24 bg-gradient-to-tr from-primary to-primary-light rounded-[2rem] flex items-center justify-center mx-auto shadow-2xl rotate-3">
                    <span class="material-icons text-white text-5xl">dashboard</span>
                </div>

                <div class="space-y-3">
                    <h1 class="text-4xl font-black tracking-tight text-white uppercase italic">Command Center</h1>
                    <p class="text-slate-400 text-sm font-bold opacity-80 letter-spacing-wide">SECURE ADMINISTRATIVE
                        ACCESS</p>
                </div>

                <form id="login-form" class="space-y-6">
                    <div class="space-y-4 text-right">
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-500 mr-4 mb-2 block">EMAIL
                                ADDRESS</label>
                            <input type="email" id="email"
                                class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-6 text-white text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all placeholder:text-slate-600"
                                placeholder="name@example.com" required />
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-500 mr-4 mb-2 block">SECRET
                                PASSWORD</label>
                            <input type="password" id="password"
                                class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-6 text-white text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all placeholder:text-slate-600"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                        </div>
                    </div>
                    <button type="submit" id="login-btn"
                        class="w-full bg-primary hover:bg-primary-light text-white py-5 rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-2xl hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                        <span>INITIATE LOGIN</span>
                        <span class="material-icons text-sm">bolt</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-container" class="hidden min-h-screen p-6 md:p-12 space-y-12 max-w-[1400px] mx-auto pb-32">
        <!-- Header -->
        <header
            class="flex flex-col md:flex-row justify-between items-start md:items-center gap-8 border-b border-white/5 pb-10">
            <div class="flex items-center gap-8">
                <div
                    class="w-20 h-20 bg-primary/20 rounded-[2rem] flex items-center justify-center border border-primary/30 relative">
                    <span class="material-icons text-primary text-4xl">flight_takeoff</span>
                    <div
                        class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-4 border-bg-dark animate-pulse">
                    </div>
                </div>
                <div>
                    <h1 class="text-4xl font-black text-white italic tracking-tighter">OPERATIONS HQ</h1>
                    <div class="flex items-center gap-4 mt-2">
                        <p id="live-time" class="text-slate-500 text-xs font-mono font-bold tracking-widest"></p>
                        <span class="w-1 h-1 bg-white/10 rounded-full"></span>
                        <p class="text-green-500 text-[10px] font-black uppercase tracking-widest">REALTIME SYNC ACTIVE
                        </p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="logout()"
                    class="glass px-8 py-4 rounded-2xl text-[10px] font-black text-slate-400 hover:text-red-500 hover:border-red-500/30 transition-all flex items-center gap-3">
                    <span class="material-icons text-sm">power_settings_new</span>
                    DISCONNECT
                </button>
            </div>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            <div class="glass p-8 rounded-[2.5rem] card-hover transition-all space-y-4">
                <div class="flex justify-between items-center">
                    <div class="w-12 h-12 bg-primary/10 rounded-2xl flex items-center justify-center">
                        <span class="material-icons text-primary">groups</span>
                    </div>
                    <span class="text-[10px] font-black text-slate-500 uppercase italic">TOTAL BOOKINGS</span>
                </div>
                <h2 id="stat-total" class="text-5xl font-black tracking-tighter">--</h2>
            </div>
            <div class="glass p-8 rounded-[2.5rem] card-hover transition-all border-l-4 border-green-500/30 space-y-4">
                <div class="flex justify-between items-center">
                    <div class="w-12 h-12 bg-green-500/10 rounded-2xl flex items-center justify-center">
                        <span class="material-icons text-green-500">check_circle</span>
                    </div>
                    <span class="text-[10px] font-black text-slate-500 uppercase italic">PAID & READY</span>
                </div>
                <h2 id="stat-paid" class="text-5xl font-black tracking-tighter text-green-500">--</h2>
            </div>
            <div class="glass p-8 rounded-[2.5rem] card-hover transition-all border-l-4 border-amber-500/30 space-y-4">
                <div class="flex justify-between items-center">
                    <div class="w-12 h-12 bg-amber-500/10 rounded-2xl flex items-center justify-center">
                        <span class="material-icons text-amber-500">schedule</span>
                    </div>
                    <span class="text-[10px] font-black text-slate-500 uppercase italic">WAITING</span>
                </div>
                <h2 id="stat-pending" class="text-5xl font-black tracking-tighter text-amber-500">--</h2>
            </div>
            <div class="glass p-8 rounded-[2.5rem] card-hover transition-all border-l-4 border-indigo-400/30 space-y-4">
                <div class="flex justify-between items-center">
                    <div class="w-12 h-12 bg-indigo-500/10 rounded-2xl flex items-center justify-center">
                        <span class="material-icons text-indigo-400">payments</span>
                    </div>
                    <span class="text-[10px] font-black text-slate-500 uppercase italic">EST. REVENUE</span>
                </div>
                <div class="flex items-baseline gap-2">
                    <h2 id="stat-revenue" class="text-5xl font-black tracking-tighter text-indigo-400">--</h2>
                    <span class="text-xs font-black text-slate-600">SAR</span>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="glass rounded-[3rem] overflow-hidden">
            <div
                class="p-10 border-b border-white/5 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                <div>
                    <h3 class="text-2xl font-black italic tracking-tight">OPERATIONAL LOGS</h3>
                    <p class="text-slate-500 text-xs font-bold mt-1">LATEST FLIGHT ACTIVITY MANIFEST</p>
                </div>
                <div class="flex items-center gap-4">
                    <div
                        class="px-5 py-3 bg-white/5 rounded-2xl text-[10px] font-black text-slate-400 uppercase tracking-widest border border-white/5">
                        RECORD LIMIT: 50</div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-right border-collapse">
                    <thead>
                        <tr class="text-[10px] font-black text-slate-600 uppercase tracking-[0.2em] bg-white/[0.01]">
                            <th class="p-8">PILOT / CUSTOMER</th>
                            <th class="p-8">FLIGHT SCHEDULE</th>
                            <th class="p-8">SERVICE TYPE</th>
                            <th class="p-8 text-center">SECURITY ASSET (QR)</th>
                            <th class="p-8 text-left">ACTION COMMANDS</th>
                        </tr>
                    </thead>
                    <tbody id="bookings-list" class="divide-y divide-white/[0.02]">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ycknumkbdltbdkhmeyqp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlja251bWtiZGx0YmRraG1leXFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMTk3MTAsImV4cCI6MjA4NjY5NTcxMH0.BNCTfaqsul1LkDbG0PyOd63rYZCThUjGxAhgNMnda6w';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const listContainer = document.getElementById('bookings-list');
        const loginContainer = document.getElementById('login-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const audio = document.getElementById('notification-sound');

        // Clock
        setInterval(() => {
            const now = new Date();
            document.getElementById('live-time').innerText = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }, 1000);

        // Session
        async function checkSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) showDashboard();
        }
        checkSession();

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const emailVal = document.getElementById('email').value;
            const passVal = document.getElementById('password').value;
            const btn = document.getElementById('login-btn');

            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin material-icons">sync</span>';

            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: emailVal,
                password: passVal,
            });

            if (error) {
                showToast("AUTH ERROR: " + error.message, "error");
                btn.disabled = false;
                btn.innerHTML = '<span>INITIATE LOGIN</span> <span class="material-icons text-sm">bolt</span>';
            } else {
                showDashboard();
            }
        });

        async function showDashboard() {
            loginContainer.classList.add('hidden');
            dashboardContainer.classList.remove('hidden');
            loadBookings();
            setupRealtime();
        }

        async function loadBookings() {
            const { data, error } = await supabaseClient
                .from('bookings')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);

            if (data) {
                renderList(data);
                updateStats(data);
            }
        }

        function renderList(bookings) {
            listContainer.innerHTML = '';
            if (bookings.length === 0) {
                listContainer.innerHTML = '<tr><td colspan="5" class="p-32 text-center text-slate-600 font-black italic tracking-widest bg-white/[0.01]">NO DATA FRAGMENT FOUND</td></tr>';
                return;
            }

            bookings.forEach(booking => {
                const currentDir = window.location.href.substring(0, window.location.href.lastIndexOf("/"));
                const verifyLink = `${currentDir}/verify.html?qr=${booking.qr_code_id}`;
                const qrImageLarge = `https://quickchart.io/qr?text=${encodeURIComponent(verifyLink)}&size=800`;
                const qrImageSmall = `https://quickchart.io/qr?text=${encodeURIComponent(verifyLink)}&size=200`;
                const cleanTime = booking.booking_time.substring(0, 5);

                const row = document.createElement('tr');
                row.className = "group hover:bg-white/[0.03] transition-all duration-300";
                row.innerHTML = `
                    <td class="p-8">
                        <div class="font-black text-lg text-white group-hover:text-primary transition-colors">${booking.customer_name}</div>
                        <a href="https://wa.me/${booking.customer_phone.replace(/\+/g, '')}" target="_blank" 
                            class="text-[11px] text-green-500 hover:text-green-400 font-black flex items-center gap-2 mt-2 tracking-wide">
                            <span class="material-icons text-[14px]">whatsapp</span>
                            ${booking.customer_phone}
                        </a>
                    </td>
                    <td class="p-8 font-mono">
                        <div class="text-xs font-black text-slate-300 tracking-tighter">${booking.booking_date}</div>
                        <div class="text-[10px] text-slate-600 font-bold mt-1">${cleanTime} HRS</div>
                    </td>
                    <td class="p-8">
                        <span class="px-4 py-1.5 bg-white/5 rounded-xl text-[10px] font-black text-slate-500 group-hover:bg-primary/20 group-hover:text-primary border border-white/5 transition-all">
                            ${booking.package}
                        </span>
                    </td>
                    <td class="p-8">
                        <div class="flex flex-col items-center gap-4">
                            <a href="${qrImageLarge}" target="_blank" class="block relative group/qr scale-90 hover:scale-100 transition-transform">
                                <img src="${qrImageSmall}" class="w-16 h-16 rounded-[1rem] border border-white/10 shadow-2xl transition-all">
                                <div class="absolute inset-0 bg-primary/20 rounded-[1rem] flex items-center justify-center opacity-0 group-hover/qr:opacity-100 transition-opacity">
                                    <span class="material-icons text-white text-md">open_in_new</span>
                                </div>
                            </a>
                            <span class="status-badge ${booking.status}">${booking.status === 'paid' ? 'PAID ‚úÖ' : (booking.status === 'completed' ? 'DONE ‚úàÔ∏è' : 'PENDING ‚è≥')}</span>
                        </div>
                    </td>
                    <td class="p-8 text-left">
                        <button onclick="copyMsg('${booking.customer_name}', '${booking.booking_date}', '${cleanTime}', '${booking.qr_code_id}')" 
                            class="glass px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-primary hover:text-white transition-all shadow-xl active:scale-95">
                            WHATSAPP MESSAGE
                        </button>
                    </td>
                `;
                listContainer.appendChild(row);
            });
        }

        function updateStats(bookings) {
            document.getElementById('stat-total').innerText = bookings.length;
            document.getElementById('stat-paid').innerText = bookings.filter(b => b.status === 'paid' || b.status === 'completed').length;
            document.getElementById('stat-pending').innerText = bookings.filter(b => b.status === 'pending').length;

            let revenue = bookings.reduce((acc, b) => {
                if (b.status === 'paid' || b.status === 'completed') {
                    return acc + (b.package.includes('ÿ¨ÿßŸäÿ±Ÿà') ? 300 : 200);
                }
                return acc;
            }, 0);
            document.getElementById('stat-revenue').innerText = revenue;
        }

        function setupRealtime() {
            supabaseClient
                .channel('schema-db-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'bookings' }, (payload) => {
                    loadBookings();
                    if (payload.eventType === 'INSERT') {
                        showToast(`NEW LOGS: ${payload.new.customer_name}`, "success");
                        playNotify();
                    } else if (payload.eventType === 'UPDATE' && payload.new.status === 'paid') {
                        showToast(`PAYMENT COMPLETED: ${payload.new.customer_name}`, "success");
                        playNotify();
                    }
                })
                .subscribe();
        }

        function playNotify() {
            audio.play().catch(e => console.warn("AUDIO BLOCKED BY BROWSER"));
        }

        function showToast(message, type = "success") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `glass-dark px-8 py-5 rounded-[2rem] shadow-[0_20px_40px_rgba(0,0,0,0.5)] flex items-center gap-4 border border-primary/20 transition-all duration-700 toast-enter`;

            const icon = type === 'success' ? 'verified' : 'report_problem';
            const color = type === 'success' ? 'text-green-500' : 'text-red-500';

            toast.innerHTML = `
                <div class="${color} flex items-center"><span class="material-icons">${icon}</span></div>
                <div class="flex flex-col">
                    <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">SYSTEM ALERT</span>
                    <span class="text-xs font-bold text-white">${message}</span>
                </div>
            `;

            container.appendChild(toast);
            setTimeout(() => toast.classList.add('toast-visible'), 50);
            setTimeout(() => {
                toast.classList.remove('toast-visible');
                setTimeout(() => toast.remove(), 700);
            }, 6000);
        }

        function copyMsg(name, date, time, qr) {
            const currentDir = window.location.href.substring(0, window.location.href.lastIndexOf("/"));
            const verifyLink = `${currentDir}/verify.html?qr=${qr}`;

            // Simplified msg - emphasize the verified link which has the QR
            const msg = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${name}!\nÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ¨ÿ≤ŸÉ ŸÅŸä ŸÜÿßÿØŸä ÿßŸÑÿ≠ÿ±Ÿäÿ∂ÿ© ŸÑŸÑÿ∑Ÿäÿ±ÿßŸÜ ‚úàÔ∏è\n\nüìÖ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${date}\n‚è∞ ÿßŸÑŸàŸÇÿ™: ${time}\n\nŸäÿ±ÿ¨Ÿâ ŸÅÿ™ÿ≠ ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ™ÿßŸÑŸä ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿ±ŸÖÿ≤ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ ÿπŸÜÿØ ÿßŸÑŸàÿµŸàŸÑ:\n${verifyLink}\n\nŸÜÿ™ÿ∑ŸÑÿπ ŸÑÿ±ÿ§Ÿäÿ™ŸÉ ŸÅŸä ÿ≥ŸÖÿßÿ° ÿßŸÑÿ≠ÿ±Ÿäÿ∂ÿ©!`;

            navigator.clipboard.writeText(msg).then(() => {
                showToast("WHATSAPP MESSAGE COPIED");
            });
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.reload();
        }
    </script>
</body>

</html>